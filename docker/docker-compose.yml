

services:
  db:
    image: postgres:15-alpine
    container_name: db
    environment:
      POSTGRES_DB: academic_linkage
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: securepass123
    ports: ["5432:5432"]
    volumes: [./init-db:/docker-entrypoint-initdb.d, pg:/var/lib/postgresql/data]
    healthcheck: { test: ["CMD-SHELL", "pg_isready -U admin"], interval: 10s, timeout: 5s, retries: 3 }

  redis:
    image: redis:7.2-alpine
    container_name: redis
    ports: ["6379:6379"]
    healthcheck: { test: ["CMD", "redis-cli", "ping"], interval: 10s, timeout: 5s, retries: 3 }

  zookeeper:
    image: zookeeper:3.9
    container_name: zookeeper
    environment:
      ZOO_MY_ID: 1
      ZOO_SERVERS: server.1=zookeeper:2888:3888;2181

  kafka:
    image: apache/kafka:3.7.0
    container_name: kafka
    ports: ["9092:9092"]
    environment:
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_NODE_ID: 1
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@zookeeper:2181
      KAFKA_LISTENERS: PLAINTEXT://:9092,CONTROLLER://:9093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://host.docker.internal:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      CLUSTER_ID: 4L6g3nShT-eMC3GMQ9H7KQ
    depends_on: [zookeeper]
    extra_hosts: ["host.docker.internal:host-gateway"]

  emqx:
    image: emqx/emqx:5.7.1
    container_name: emqx
    ports:
      - "1883:1883"
      - "18083:18083"
    healthcheck: { test: ["CMD", "curl -f http://localhost:18083/status"], interval: 30s, timeout: 20s, retries: 3 }

  gateway:
    build: ./docker/nginx
    container_name: gateway
    ports: ["8000:80"]
    depends_on: [user-service, activity-service, document-service]

  user-service: &microservice
    build: ./backend/user-service
    container_name: user-service
    environment:
      DB_HOST: db
      AWS_REGION: us-east-1
      JWT_SECRET: my_jwt_secret_2026
    depends_on: [db]

  activity-service:
    <<: *microservice
    build: ./backend/activity-service
    container_name: activity-service

  evidence-service:
    <<: *microservice
    build: ./backend/evidence-service
    container_name: evidence-service
    environment:
      AWS_S3_BUCKET: academic-linkage-evidence-dev
      KAFKA_BROKER: kafka:9092
      MQTT_HOST: emqx
      MQTT_PORT: 1883

  approval-service:
    <<: *microservice
    build: ./backend/approval-service
    container_name: approval-service
    environment:
      KAFKA_BROKER: kafka:9092

  document-service:
    <<: *microservice
    build: ./backend/document-service
    container_name: document-service
    environment:
      AWS_S3_BUCKET: academic-linkage-docs-dev

  agreement-service:
    <<: *microservice
    build: ./backend/agreement-service
    container_name: agreement-service

  audit-service:
    <<: *microservice
    build: ./backend/audit-service
    container_name: audit-service

  notification-service:
    <<: *microservice
    build: ./backend/notification-service
    container_name: notification-service
    environment:
      MQTT_HOST: emqx
      MQTT_PORT: 1883

  event-service:
    <<: *microservice
    build: ./backend/event-service
    container_name: event-service
    environment:
      KAFKA_BROKER: kafka:9092
      MQTT_HOST: emqx
      MQTT_PORT: 1883

  backup-service:
    <<: *microservice
    build: ./backend/backup-service
    container_name: backup-service
    environment:
      AWS_S3_BUCKET: academic-linkage-backups-dev

  frontend-web:
    build: ./frontend/web
    container_name: frontend-web
    ports: ["3000:80"]
    depends_on: [gateway]

volumes:
  pg: {}