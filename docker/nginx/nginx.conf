# docker/nginx/nginx.conf
# RNF4: JWT (header simulation), rate limiting 100/min
# RNF22: CORS + bastion-like

limit_req_zone $binary_remote_addr zone=api:10m rate=100r/m;

upstream user_service { server user-service:8001; }
upstream activity_service { server activity-service:8002; }
upstream document_service { server document-service:8005; }

server {
    listen 80;
    server_name localhost;

    location = /health {
        return 200 'OK';
        add_header Content-Type text/plain;
    }

    location /login {
        limit_req zone=api burst=20;
        proxy_pass http://user_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /api/ {
        limit_req zone=api burst=20;
        if ($http_authorization = "") {
            return 401 "Missing JWT token (use: Authorization: Bearer <any>)";
        }
        add_header 'Access-Control-Allow-Origin' '*' always;
        add_header 'Access-Control-Allow-Methods' 'GET, POST, OPTIONS' always;
        add_header 'Access-Control-Allow-Headers' 'Authorization, Content-Type' always;
        if ($request_method = 'OPTIONS') { return 204; }
        proxy_pass http://activity_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }

    location /pdf/ {
        limit_req zone=api burst=10;
        proxy_pass http://document_service;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
    }
}