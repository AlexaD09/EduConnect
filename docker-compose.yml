services:
  db:
    image: postgres:15
    container_name: user-db
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: Liliana0912
      POSTGRES_DB: bd_academic_users
    ports:
      - "5433:5432"
    volumes:
      - ./backend/user-service/db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d bd_academic_users"]
      interval: 5s
      timeout: 5s
      retries: 5

  user-service:
    build: ./backend/user-service
    container_name: user-service
    environment:
      DB_HOST: db
      DB_PORT: 5432
      DB_NAME: bd_academic_users
      DB_USER: postgres
      DB_PASSWORD: Liliana0912
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8001:8000"

  frontend:
    build:
      context: ./frontend/web
      args:
        VITE_USER_SERVICE_URL: http://localhost:8001
       
    container_name: user-frontend
    ports:
      - "3000:80"


  agreement-service:
    build: ./backend/agreement-service
    container_name: agreement-service
    environment:
      DB_HOST: agreement-db
      DB_PORT: 5432
      DB_NAME: agreement_db
      DB_USER: admin
      DB_PASSWORD: securepass123  
      POSTGRES_DB: agreement_db
    depends_on:
      agreement-db:
        condition: service_healthy  
      user-service:
        condition: service_started
    ports:
      - "8002:8000"    
      

  agreement-db:
    image: postgres:15-alpine
    container_name: agreement-db
    environment:
      POSTGRES_DB: agreement_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: securepass123
    ports:
        - "5434:5432"  
    volumes:
      - ./backend/agreement-service/db:/docker-entrypoint-initdb.d
    healthcheck:  
      test: ["CMD-SHELL", "pg_isready -U admin -d agreement_db"]
      interval: 5s
      timeout: 5s
      retries: 5


  activity-db:
    image: postgres:15-alpine
    container_name: activity-db
    environment:
      POSTGRES_DB: activity_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: securepass123
      
    ports:
      - "5435:5432"  
    volumes:
      - ./backend/activity-service/db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d activity_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  activity-service:
    build: ./backend/activity-service
    container_name: activity-service
    environment:
      DB_HOST: activity-db
      DB_PORT: 5432
      DB_NAME: activity_db
      DB_USER: admin
      DB_PASSWORD: securepass123
    depends_on:
      activity-db:
        condition: service_healthy
      agreement-service:
        condition: service_started
    ports:
      - "8003:8000"  
    volumes:
      - activity_storage:/app/storage



  approval-db:
    image: postgres:15-alpine
    container_name: approval-db
    environment:
      POSTGRES_DB: approval_db
      POSTGRES_USER: admin
      POSTGRES_PASSWORD: securepass123
    ports:
      - "5436:5432"
    volumes:
      - ./backend/approval-service/db:/docker-entrypoint-initdb.d
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U admin -d approval_db"]
      interval: 5s
      timeout: 5s
      retries: 5

  approval-service:
    build: ./backend/approval-service
    container_name: approval-service
    environment:
      DB_HOST: approval-db
      DB_PORT: 5432
      DB_NAME: approval_db
      DB_USER: admin
      DB_PASSWORD: securepass123
    depends_on:
      approval-db:
        condition: service_healthy
      activity-service:
        condition: service_started
    ports:
      - "8004:8000"

volumes:
  activity_storage:      

