name: CI Build + Push (only changed services)

on:
  push:
    branches: [ features, qa, main ]
    paths:
      - "packages/**"
      - "turbo.json"
      - "package.json"
      - "package-lock.json"
      - "pnpm-lock.yaml"
      - "yarn.lock"
  workflow_dispatch:

concurrency:
  group: ci-${{ github.ref_name }}
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set tag and env alias
        id: meta
        run: |
          if [ "${GITHUB_REF_NAME}" = "main" ]; then
            echo "TAG=prod-${GITHUB_SHA::7}" >> $GITHUB_ENV
            echo "ENV_ALIAS=prod" >> $GITHUB_ENV
          else
            echo "TAG=qa-${GITHUB_SHA::7}" >> $GITHUB_ENV
            echo "ENV_ALIAS=qa" >> $GITHUB_ENV
          fi

      - name: Detect changed services
        id: changes
        run: |
          BASE="${{ github.event.before }}"
          if [ -z "$BASE" ] || [ "$BASE" = "0000000000000000000000000000000000000000" ]; then
            BASE="$(git rev-list --max-parents=0 HEAD)"
          fi

          SERVICES=$(git diff --name-only "$BASE" "$GITHUB_SHA" | awk -F/ '
            $1=="packages" && $2=="backend" && $3!="" {print $3}
          ' | sort -u)

          if [ -z "$SERVICES" ]; then
            echo "CHANGED=false" >> $GITHUB_ENV
            exit 0
          fi

          echo "CHANGED=true" >> $GITHUB_ENV
          printf '%s\n' "$SERVICES" > .services.txt

      - uses: actions/setup-node@v4
        if: env.CHANGED == 'true'
        with:
          node-version: 20
          
      - name: Install deps
        if: env.CHANGED == 'true'
        run: npm ci

      - name: Docker login
        if: env.CHANGED == 'true'
        run: |
          echo "${{ secrets.DOCKERHUB_PASSWORD }}" | docker login -u "${{ secrets.DOCKERHUB_USERNAME }}" --password-stdin

      - name: Build + Push only changed backend services
        if: env.CHANGED == 'true'
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
        run: |
          while read -r SVC; do
            cd "packages/backend/$SVC"
            npm run docker:build
            npm run docker:push
            cd - >/dev/null
          done < .services.txt

      - name: Write deploy manifest (single file)
        if: env.CHANGED == 'true'
        run: |
          mkdir -p .artifacts
          SERVICES_JSON=$(awk 'BEGIN{printf "["} {gsub(/"/,""); printf "%s\"%s\"", (NR==1?"":","), $0} END{printf "]"}' .services.txt)
          echo "{ \"services\": $SERVICES_JSON, \"tag\": \"${TAG}\", \"env\": \"${ENV_ALIAS}\" }" > .artifacts/manifest.json

      - name: Upload manifest
        if: env.CHANGED == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: deploy-manifest
          path: .artifacts/manifest.json
          if-no-files-found: error
