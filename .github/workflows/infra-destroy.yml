name: Infra Destroy (manual)

on:
  workflow_dispatch:
    inputs:
      env:
        description: "qa o prod"
        required: true
        default: "qa"
        type: choice
        options:
          - qa 
          - prod


jobs:
  destroy:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

    
      - uses: aws-actions/configure-aws-credentials@v4
        with:
            aws-access-key-id:     ${{ secrets.AWS_BASTION_ACCESS_KEY_ID }}
            aws-secret-access-key: ${{ secrets.AWS_BASTION_SECRET_ACCESS_KEY }}
            aws-session-token:     ${{ secrets.AWS_BASTION_SESSION_TOKEN }}
            aws-region: us-east-1

      - name: Build tfvars (base file + secrets override)
        working-directory: infra/terraform
        run: |
          ENV="${{ inputs.env }}"

          if [ "$ENV" = "prod" ]; then
            cp prod.tfvars /tmp/env.tfvars
            EIPALLOC="${{ secrets.BASTION_EIPALLOC_PROD }}"
            FRONT_AK="${{ secrets.AWS_FRONTEND_ACCESS_KEY_ID_PROD }}"
            FRONT_SK="${{ secrets.AWS_FRONTEND_SECRET_ACCESS_KEY_PROD }}"
            FRONT_TK="${{ secrets.AWS_FRONTEND_SESSION_TOKEN_PROD }}"
            MSA_AK="${{ secrets.AWS_MSA_ACCESS_KEY_ID_PROD }}"
            MSA_SK="${{ secrets.AWS_MSA_SECRET_ACCESS_KEY_PROD }}"
            MSA_TK="${{ secrets.AWS_MSA_SESSION_TOKEN_PROD }}"
            MSB_AK="${{ secrets.AWS_MSB_ACCESS_KEY_ID_PROD }}"
            MSB_SK="${{ secrets.AWS_MSB_SECRET_ACCESS_KEY_PROD }}"
            MSB_TK="${{ secrets.AWS_MSB_SESSION_TOKEN_PROD }}"
            DATA_AK="${{ secrets.AWS_DATA_ACCESS_KEY_ID_PROD }}"
            DATA_SK="${{ secrets.AWS_DATA_SECRET_ACCESS_KEY_PROD }}"
            DATA_TK="${{ secrets.AWS_DATA_SESSION_TOKEN_PROD }}"
            BAS_AK="${{ secrets.AWS_BASTION_ACCESS_KEY_ID_PROD }}"
            BAS_SK="${{ secrets.AWS_BASTION_SECRET_ACCESS_KEY_PROD }}"
            BAS_TK="${{ secrets.AWS_BASTION_SESSION_TOKEN_PROD }}"
          else
            cp qa.tfvars /tmp/env.tfvars
            EIPALLOC="${{ secrets.BASTION_EIPALLOC_QA }}"
            FRONT_AK="${{ secrets.AWS_FRONTEND_ACCESS_KEY_ID_QA }}"
            FRONT_SK="${{ secrets.AWS_FRONTEND_SECRET_ACCESS_KEY_QA }}"
            FRONT_TK="${{ secrets.AWS_FRONTEND_SESSION_TOKEN_QA }}"
            MSA_AK="${{ secrets.AWS_MSA_ACCESS_KEY_ID_QA }}"
            MSA_SK="${{ secrets.AWS_MSA_SECRET_ACCESS_KEY_QA }}"
            MSA_TK="${{ secrets.AWS_MSA_SESSION_TOKEN_QA }}"
            MSB_AK="${{ secrets.AWS_MSB_ACCESS_KEY_ID_QA }}"
            MSB_SK="${{ secrets.AWS_MSB_SECRET_ACCESS_KEY_QA }}"
            MSB_TK="${{ secrets.AWS_MSB_SESSION_TOKEN_QA }}"
            DATA_AK="${{ secrets.AWS_DATA_ACCESS_KEY_ID_QA }}"
            DATA_SK="${{ secrets.AWS_DATA_SECRET_ACCESS_KEY_QA }}"
            DATA_TK="${{ secrets.AWS_DATA_SESSION_TOKEN_QA }}"
            BAS_AK="${{ secrets.AWS_BASTION_ACCESS_KEY_ID_QA }}"
            BAS_SK="${{ secrets.AWS_BASTION_SECRET_ACCESS_KEY_QA }}"
            BAS_TK="${{ secrets.AWS_BASTION_SESSION_TOKEN_QA }}"
          fi

          sed -i '/_access_key/d;/_secret_key/d;/_session_token/d;/bastion_eip_allocation_id/d' /tmp/env.tfvars

          cat >> /tmp/env.tfvars <<EOF
          bastion_eip_allocation_id = "$EIPALLOC"

          frontend_access_key = "$FRONT_AK"
          frontend_secret_key = "$FRONT_SK"
          frontend_session_token = "$FRONT_TK"

          ms_a_access_key = "$MSA_AK"
          ms_a_secret_key = "$MSA_SK"
          ms_a_session_token = "$MSA_TK"

          ms_b_access_key = "$MSB_AK"
          ms_b_secret_key = "$MSB_SK"
          ms_b_session_token = "$MSB_TK"

          data_access_key = "$DATA_AK"
          data_secret_key = "$DATA_SK"
          data_session_token = "$DATA_TK"

          bastion_access_key = "$BAS_AK"
          bastion_secret_key = "$BAS_SK"
          bastion_session_token = "$BAS_TK"
          EOF

                    echo "TFV=/tmp/env.tfvars" >> $GITHUB_ENV


      - name: Terraform destroy (infra)
        working-directory: infra/terraform
        run: |
          # backend seg√∫n env
          if [ "${{ inputs.env }}" = "prod" ]; then
            BACKEND="backend-prod.hcl"
          else
            BACKEND="backend-qa.hcl"
          fi

          terraform init -reconfigure -backend-config="$BACKEND"
          terraform destroy -var-file="$TFV" -auto-approve
