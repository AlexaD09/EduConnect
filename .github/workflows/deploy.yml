name: CD Deploy (only changed services)

on:
  workflow_call:
    inputs:
      tag:
        required: true
        type: string
      env_alias:
        required: true
        type: string
      services:
        required: true
        type: string

concurrency:
  group: cd-${{ inputs.env_alias }}
  cancel-in-progress: true

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set TF backend/vars from env_alias
        run: |
          echo "TAG=${{ inputs.tag }}" >> $GITHUB_ENV
          echo "ENV_ALIAS=${{ inputs.env_alias }}" >> $GITHUB_ENV
          echo "SERVICES=${{ inputs.services }}" >> $GITHUB_ENV

          if [ "${{ inputs.env_alias }}" = "prod" ]; then
            echo "TF_BACKEND=backend-prod.hcl" >> $GITHUB_ENV
            echo "TFVARS=prod.tfvars" >> $GITHUB_ENV
          else
            echo "TF_BACKEND=backend-qa.hcl" >> $GITHUB_ENV
            echo "TFVARS=qa.tfvars" >> $GITHUB_ENV
          fi

      - uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: 1.6.6

      - name: Configure AWS creds (bastion account)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id:     ${{ secrets.AWS_BASTION_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_BASTION_SECRET_ACCESS_KEY }}
          aws-session-token:     ${{ secrets.AWS_BASTION_SESSION_TOKEN }}
          aws-region: us-east-1

      - name: Terraform init (read outputs)
        run: terraform -chdir=infra/terraform init -reconfigure -backend-config=$TF_BACKEND

      - name: Get bastion public ip
        id: bastion
        run: |
          echo "HOST=$(terraform -chdir=infra/terraform output -raw bastion_public_ip)" >> $GITHUB_OUTPUT

      - name: Prepare SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_QA }}" | tr -d '\r' > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa

      - name: Push public key to bastion (EC2 Instance Connect)
        run: |
          INSTANCE_ID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=*bastion*" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" --output text)

          AZ=$(aws ec2 describe-instances \
            --instance-ids "$INSTANCE_ID" \
            --query "Reservations[0].Instances[0].Placement.AvailabilityZone" --output text)

          aws ec2-instance-connect send-ssh-public-key \
            --instance-id "$INSTANCE_ID" \
            --availability-zone "$AZ" \
            --instance-os-user ec2-user \
            --ssh-public-key "${{ secrets.SSH_PUBLIC_KEY_QA }}"

      - name: Test SSH to bastion
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -o IdentitiesOnly=yes ec2-user@44.213.10.36 "whoami && hostname"





      

      - name: Deploy changed services (real)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_PASSWORD: ${{ secrets.DOCKERHUB_PASSWORD }}
          BASTION_HOST: ${{ steps.bastion.outputs.HOST }}
        run: |
          ENDPOINTS_JSON=$(terraform -chdir=infra/terraform output -json service_endpoints)
          ssh-keyscan -H "$BASTION_HOST" >> ~/.ssh/known_hosts
          chmod 644 ~/.ssh/known_hosts

          for SVC in $SERVICES; do
            IP=$(echo "$ENDPOINTS_JSON" | python3 -c "import sys,json; d=json.load(sys.stdin); print(d['$SVC']['ip'])")

            INSTANCE_ID=$(aws ec2 describe-instances \
              --filters "Name=private-ip-address,Values=$IP" \
              --query "Reservations[0].Instances[0].InstanceId" --output text)

            if [ "$INSTANCE_ID" = "None" ] || [ -z "$INSTANCE_ID" ]; then
              echo "Could not find instance for $SVC ($IP)"
              continue
            fi

            SUBNET_ID=$(aws ec2 describe-instances \
              --instance-ids "$INSTANCE_ID" \
              --query "Reservations[0].Instances[0].SubnetId" --output text)

            VPC_ID=$(aws ec2 describe-instances \
              --instance-ids "$INSTANCE_ID" \
              --query "Reservations[0].Instances[0].VpcId" --output text)

            SG_IDS=$(aws ec2 describe-instances \
              --instance-ids "$INSTANCE_ID" \
              --query "Reservations[0].Instances[0].SecurityGroups[].GroupId" --output text)

            echo "TARGET IP=$IP INSTANCE_ID=$INSTANCE_ID VPC=$VPC_ID SUBNET=$SUBNET_ID SGs=$SG_IDS"
            echo "Route table for subnet $SUBNET_ID:"
            aws ec2 describe-route-tables \
              --filters "Name=association.subnet-id,Values=$SUBNET_ID" \
              --query "RouteTables[0].Routes" --output table

            echo "Testing SSH port 22 from bastion to $SVC ($IP)"
            ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa -o IdentitiesOnly=yes ec2-user@"$BASTION_HOST" \
              "timeout 4 bash -lc 'echo >/dev/tcp/$IP/22' && echo PORT22_OPEN || echo PORT22_BLOCKED" || true
          done
